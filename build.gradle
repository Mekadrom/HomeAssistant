buildscript {
    repositories {
        mavenLocal()
    }
}

plugins {
    id 'org.springframework.boot' version '2.5.0'
    id 'java'
    id "io.freefair.lombok" version "6.3.0"
}

sourceCompatibility = 17
targetCompatibility = 17

ext {
    distDir = 'dist'
}

repositories {
    mavenLocal()
    mavenCentral()
}

task buildAll {
    dependsOn ':common:build'
    dependsOn ':common:publishToMavenLocal'
    dependsOn ':server:build'
    dependsOn ':actionserver:build'
    dependsOn ':actionserver:bootJar'
}

clean.doFirst {
    delete "${distDir}"
}

task distribute {
    dependsOn 'buildAll'
    dependsOn project.hasProperty('buildProd') ? ':frontend:buildFrontend' : ':frontend:buildFrontendDev'
    finalizedBy 'copyToDist'
}

task copyToDist(type: Copy) {
    dependsOn clean
    doFirst {
        mkdir "${distDir}"

        subprojects.stream().forEach {
            mkdir "${distDir}/${it.name}"
        }
    }

    into("${distDir}")

    // only include fatjars
    ['server', 'actionserver'].forEach {proj ->
        into("${proj}") {
            with copySpec {
                from("${proj}/build/libs") {
                    exclude '*-*'
                }
            }
        }
    }

    // include all libs
    ['common'].forEach {proj ->
        into("${proj}") {
            with copySpec {
                from("${proj}/build/libs")
            }
        }
    }

    // not a jar
    into('frontend') {
        with copySpec {
            from('frontend/dist/frontend')
        }
    }
}

test {
    dependsOn ':actionserver:test'
    dependsOn ':common:test'
    dependsOn ':frontend:test'
    dependsOn ':server:test'
}
